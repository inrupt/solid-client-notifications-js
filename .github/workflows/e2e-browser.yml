name: End-to-end Tests (Browser)

on:
  deployment_status:
    branches-ignore:
      - 'dependabot/npm_and_yarn/**'
  workflow_dispatch:

env:
  CI: true
jobs:
  build:
    runs-on: ubuntu-20.04
    if: ${{github.event.deployment_status.state == 'success'}}
    steps:
    - uses: actions/checkout@v2.3.4
    - name: Use Node.js 14.x
      uses: actions/setup-node@v2.1.5
      with:
        node-version: 14.x
    - name: Cache node modules
      uses: actions/cache@v2.1.4
      env:
        cache-name: cache-node-modules
      with:
        path: node_modules
        key: ${{ runner.os }}-node${{ runner.node-version }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
    - run: npm run build
    # Ideally, we'd autodetect installed browsers and run them headlessly.
    # See https://github.com/DevExpress/testcafe/issues/5641
    - name: Prepare browser-based end-to-end tests
      run: |
        cd .codesandbox/sandbox
        npm install
        # Run the end-to-end tests against the code in this branch specifically:
        npm install ../../
        cd ../../
    - name: Run browser-based end-to-end tests (Linux)
      # TODO: Add Edge/merge with Windows setup once Edge is available on Linux:
      run: npm run e2e-test-browser -- firefox:headless,chrome:headless
      env:
        E2E_TEST_ESS_NOTIFICATION_GATEWAY: ${{secrets.E2E_TEST_ESS_PROD_NOTIFICATION_GATEWAY}}
        E2E_TEST_ESS_IDP_URL: ${{ secrets.E2E_TEST_ESS_PROD_IDP_URL }}
        E2E_TEST_ESS_POD: ${{ secrets.E2E_TEST_ESS_PROD_POD }}
        E2E_TEST_ESS_COGNITO_USER: ${{ secrets.E2E_TEST_ESS_PROD_COGNITO_USER }}
        E2E_TEST_ESS_COGNITO_PASSWORD: ${{ secrets.E2E_TEST_ESS_PROD_COGNITO_PASSWORD }}
    - name: Add status check with successful test result
      id: set-status-check-success
      uses: octokit/request-action@v2.x
      with:
        route: POST /repos/:repository/statuses/:ref
        repository: ${{ github.repository }}
        ref: ${{ github.sha }}
        state: success
        context: 'End-to-end tests (browser)'
        description: 'TestCafe clicking through the demo application deployed to Vercel'
        target_url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}?check_suite_focus=true
        # The deployment runs in parallel with CI, so status checks will never have succeeded yet:
        required_contexts: "[]"
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
    - name: Add status check with failed test result
      id: set-status-check-failure
      if: failure()
      uses: octokit/request-action@v2.x
      with:
        route: POST /repos/:repository/statuses/:ref
        repoitory: ${{ github.repository }}
        ref: ${{ github.sha }}
        state: failure
        context: 'End-to-end tests (browser)'
        description: 'TestCafe clicking through the demo application deployed to Vercel'
        target_url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}?check_suite_focus=true
        # The deployment runs in parallel with CI, so status checks will never have succeeded yet:
        required_contexts: "[]"
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
